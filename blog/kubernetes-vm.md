# å¼ºéš”ç¦»å®¹å™¨çš„é‚£äº›äº‹

> ä¸ºä»€ä¹ˆéœ€è¦å¼ºéš”ç¦»å®¹å™¨

æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œå®¹å™¨å·²ä¹…ï¼Œç¬¬ä¸€æ¬¡å¯¹å¼ºéš”ç¦»å®¹å™¨è¯‰æ±‚æ˜¯javaç±»åº”ç”¨å¼•èµ·çš„ï¼Œå¦‚æœä¸é…ç½®jvmå‚æ•°ï¼Œjavaè™šæ‹Ÿæœºä¼šæ ¹æ®ç³»ç»Ÿèµ„æºä¿¡æ¯è¿›è¡Œå†…å­˜gcçº¿ç¨‹æ•°ç­‰é…ç½®ï¼Œåœ¨ä¸ç»™å®¹å™¨é…é¢çš„æƒ…å†µä¸‹é—®é¢˜ä¸å¤§ï¼Œä¸€æ—¦é…é¢äº†ã€‚ã€‚ã€‚

æ™®é€šçš„å®¹å™¨åœ¨å®¹å™¨ä¸­çœ‹åˆ°çš„èµ„æºè¿˜æ˜¯å®¿ä¸»æœºçš„èµ„æºï¼Œé‚£ä¹ˆå‡è®¾å®¿ä¸»æœº128Gè€Œä½ ç»™å®¹å™¨é…é¢2Gï¼Œæ­¤æ—¶å †å†…å­˜æŒ‰ç…§128Gå»åˆ†ï¼Œå¯æƒ³è€ŒçŸ¥åæœï¼ŒåŒç†è¿˜æœ‰gcçº¿ç¨‹æ•°ç­‰
<!--more-->

> ç»™jvmé…ç½®å‚æ•°å°±è¡Œäº†å‘—

æˆ‘ä»¬å¾ˆéš¾æ”¹å˜ç”¨æˆ·è¡Œä¸ºï¼Œè®©ç”¨æˆ·éƒ½å»æ”¹åŠ¨å‚æ•°ä¸å¤ªç°å®ã€‚

> lxcfsä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†è¿™ä¸ªé—®é¢˜

![](/lxcfs.jpg)

lxcfså¯ä»¥è®©å®¹å™¨æœ‰æ›´å¥½çš„èµ„æºå¯è§†æ€§ï¼Œå¦‚å†…å­˜ï¼Œcpusetç­‰ï¼ŒåŸç†ä¹Ÿéå¸¸ç®€å•ï¼Œå°±æ˜¯æŠŠprocä¸‹çš„ä¸€äº›æ–‡ä»¶è¿˜åœ¨ç»™å®¹å™¨ï¼Œå®¹å™¨å†…è¿›ç¨‹è¯»å–èµ„æºä¿¡æ¯æ—¶ç³»ç»Ÿè°ƒç”¨ä¼šè¢«lxcfsæ‹¦æˆªï¼Œç„¶ååˆ°cgroupä¸‹å»æŸ¥è¯¥è¿›ç¨‹èµ„æºé…é¢ä¿¡æ¯è¿›è¡Œè®¡ç®—ï¼Œå¤§éƒ¨åˆ†åœºæ™¯å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹å¼ä¿®ä¿®è¡¥è¡¥

![](/lxcfs1.jpg)


> ç„¶é¹…ï¼Œlxcfsçš„ç¼ºé™·

ç¬¬ä¸€ï¼Œæ”¯æŒlxcfsçš„è¿è¡Œæ—¶ç”šå°‘
ç¬¬äºŒï¼Œç”¨æˆ·ä½¿ç”¨æ—¶ä¸é€æ˜ï¼Œéœ€è¦è‡ªè¡ŒæŒ‚è½½å¾ˆå¤šæ–‡ä»¶ä¸å‹å¥½
ç¬¬ä¸‰ï¼Œç”±äºç¬¬äºŒç‚¹ï¼Œä½ å°±å¾—å»å¼€å‘ä¸€äº›ç‰¹æ€§å»æ”¯æŒå®ƒï¼Œä¸»æµæ–¹å¼æœ‰å‡ ç§
    1.k8sä¸Šç›‘å¬ä¸€äº›å¯¹è±¡çš„åˆ›å»ºï¼Œè¿›è¡Œä¿®æ”¹
    2.ä¿®æ”¹kubeletï¼Œåœ¨volumeé‡Œé»˜è®¤åŠ ä¸Šï¼Œæˆ‘ä»¬å°±æ˜¯è¿™æ ·åšçš„ï¼Œæ­£åœ¨æŠŠè¿™ä¸ªç‰¹æ€§PRç»™ç¤¾åŒº
    3.ä¿®æ”¹runtimeï¼Œæˆ–è€…ç›´æ¥é€‰æ‹©æ”¯æŒè¿™ä¸ªç‰¹æ€§çš„è¿è¡Œæ—¶ï¼Œå¦‚pouch
ç¬¬å››ï¼Œcpushareçš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¹Ÿæ­£åœ¨æŠŠè¿™ä¸ªç‰¹æ€§prç»™ç¤¾åŒºï¼Œé€šè¿‡è®¡ç®—å æ¯”æŠŠè®¡ç®—åçš„cpuæ ¸æ•°ä¸ŠæŠ¥ç»™è¿›ç¨‹
ç¬¬äº”ï¼Œå¾ˆå¤šåº”ç”¨ä»systemä¸‹é¢å»è¯»å–èµ„æºä¿¡æ¯ï¼Œè€Œéprocï¼Œè¿™æ ·åˆæ˜¯ä¸€å¤§æ³¢å®šåˆ¶éœ€æ±‚ã€‚ã€‚ã€‚è¿˜æœ‰remoutç­‰ç­‰é—®é¢˜

æ€»ä½“æ¥è¯´éƒ½æ˜¯ä¿®ä¿®è¡¥è¡¥ï¼Œä¸èƒ½ä»å½»åº•ä¸Šè§£å†³é—®é¢˜

è¿™è®©æˆ‘è¶Šæ¥è¶Šçœ‹å¥½è½»é‡çº§è™šæ‹ŸåŒ–æŠ€æœ¯

kata runvç­‰æŠ€æœ¯çš„å‡ºç°çœŸçš„æ˜¯æŠŠè™šæ‹Ÿæœºå®¹å™¨çš„ä¼˜åŠ¿å¼ºå¼ºç»“åˆï¼Œå®¹å™¨çš„è°ƒåº¦ç¼–æ’ç®¡ç†ç”Ÿæ€ï¼Œé•œåƒæ ‡å‡†ï¼Œå†åŠ ä¸Šè™šæ‹Ÿæœºçš„å¼ºéš”ç¦»

![](/kata.jpg)


ä¸‹é¢å¼€å§‹ä¸€å¤§æ³¢åè¯è§£é‡Šä»¥åŠä»–ä»¬ä¹‹é—´çš„å…³ç³»

containerdåœ°ä½éš¾ä»¥æ’¼åŠ¨ï¼ŒçœŸæ­£ç®¡ç†å®¹å™¨çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œk8så’Œdockeréƒ½å¯ä»¥é€šè¿‡unix socketå»è°ƒç”¨å®ƒï¼Œç„¶åæ¯èµ·ä¸€ä¸ªå®¹å™¨containerdä¼šå»è°ƒç”¨runc runv kataç­‰

kata runv qemu firecracker rust-vmméƒ½æ˜¯å•¥å…³ç³»

kataå’Œrunvéƒ½æ˜¯å¯ä»¥è¢«containerdè°ƒç”¨ç„¶åè°ƒç”¨qemuå‘½ä»¤å»å¯åŠ¨è™šæ‹Ÿæœº

qemu å’Œfirecrackeræ˜¯ä¸€ä¸ªçº§åˆ«ï¼ŒçœŸæ­£å»å¯åŠ¨è™šæ‹Ÿæœºçš„ï¼Œå’Œå¼ ç£Šå¤§ä½¬äº¤æµæ—¶è¿™é‡Œå¼•ç”¨å¤§ä½¬ä¸€å¥è¯:qemuæ˜¯åœ¨ä¸€å¤§å¨åŠŸèƒ½ä¸Šåšå‡æ³•ï¼Œfirecrackeræ˜¯åœ¨éå¸¸æ ¸å¿ƒç®€å•çš„åŠŸèƒ½ä¸ŠåšåŠ æ³•ã€‚

é‚£ä¹ˆæˆ‘ä»¬åˆ°åº•å› è¯¥é€‰qemuè¿˜æ˜¯firecrackerå‘¢ï¼Œé‚£è‚¯å®šæ˜¯ä¸åœºæ™¯ç›¸å…³äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ç”¨é‡é‡çº§è™šæ‹Ÿæœºï¼Œæœ‰çŠ¶æ€ï¼Œéœ€è¦è¿ç§»ï¼Œéœ€è¦systemd sshdç­‰ï¼Œé‚£ä¹ˆè‚¯å®šè¿˜æ˜¯èµ°qemu libvirtï¼Œ å¦‚æœæˆ‘ä»¬èµ°è½»é‡çº§è™šæ‹Ÿæœºfirecrackeræ˜¯ä¸ªéå¸¸ä¸é”™çš„é€‰æ‹©ï¼Œè€Œä¸”æ½œåŠ›å·¨å¤§ï¼Œæ¯•ç«Ÿæ˜¯æ¥è·‘äºšé©¬é€Šå‡½æ•°è®¡ç®—çš„ï¼Œä¸æ˜¯ç›–çš„ã€‚çœ‹ä¸‹firecracker apiå°±å‘ç°çœŸç®€å•ï¼Œå†å»çœ‹qemuæ–‡æ¡£ã€‚ã€‚ã€‚ã€‚ä»€ä¹ˆ**é¸Ÿç©æ„å„¿ã€‚ã€‚ã€‚  

qemuå¤§ç¥åˆ«å–·æˆ‘ï¼Œæˆ‘æ‰¿è®¤å…¶å¼ºå¤§ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™é‡åˆ°é—®é¢˜æœ‰ç‚¹æ— ä»ä¸‹æ‰‹ï¼Œå¾ˆå¤šä½¿ç”¨æ–¹æ³•æˆ‘ä¹Ÿæ˜¯ä»æºç ä¸­æ‘¸ç´¢å‡ºæ¥çš„ï¼Œä¸ªäººè¿˜æ˜¯å–œæ¬¢æ›´è½»é‡çº§çš„ä¸œè¥¿ã€‚ä¸è¿‡æˆ‘ä¾ç„¶è¿˜æ˜¯å¯¹å­¦ä¹ qemuæœ‰å¾ˆå¤§çƒ­æƒ…ã€‚

é¡ºä¾¿æä¸€ä¸‹libvirtï¼Œæ—¢ç„¶é‡ï¼Œé‚£ä¸å¦‚å†é‡ä¸€ç‚¹ï¼Œlibvirtèƒ½è®©ä½ æ›´æ–¹ä¾¿çš„ç®¡ç†qemuè™šæ‹Ÿæœºå’Œqemuå¼€å‘ï¼Œç»†èŠ‚ä¸èµ˜è¿°äº†

rust-vmmæ˜¯ä¸ªæ›´åº•å±‚çš„ä¸€ç³»åˆ—ç»„ä»¶ï¼Œå¤§ä½¬è¯´æ˜¯æ”¿æ²»äº§ç‰©ï¼Œè‡ªå·±å¦‚æœå¯¹å†™hypervisoræœ‰å…´è¶£å¯ä»¥æŠ±ç€å­¦ä¹ æ€åº¦å»å¼€å‘ç©ï¼Œç”Ÿäº§ä¸­ç›´æ¥firecrackerå°±å¥½äº†ï¼Œæ‰€ä»¥rustçš„æ½œåŠ›è¿˜æ˜¯å·¨å¤§çš„ï¼Œä¸ºäº†å†™è™šæ‹Ÿæœºä¸ºäº†å†™æ“ä½œç³»ç»Ÿï¼Œå’Œæˆ‘ä¸€èµ·å­¦rustğŸ¤ªğŸ¤ª
 
é“ºå«çš„å·®ä¸å¤šäº†ï¼Œä¸‹é¢æ­£å¼å¼€å§‹:

å› ä¸ºkataèƒ½æ”¯æŒfirecrackerå’Œqemuï¼Œæ‰€ä»¥é’ˆå¯¹kataè¿™ä¸ªæŠ€æœ¯æ¥åšä¸ªå…·ä½“ç‚¹çš„ä»‹ç»

> è¿›ç¨‹æ¨¡å‹

![](/kata2.jpg)

æ‰€ä»¥kata runtimeæ›¿ä»£æ‰çš„æ˜¯runcéƒ¨åˆ†çš„ä¸œè¥¿ï¼Œå› ä¸ºä¸­é—´æœ‰containerdï¼Œæ‰€ä»¥ä¸Šå±‚å¦‚docker k8sæ„ŸçŸ¥ä¸åˆ°è¿è¡Œæ—¶çš„å˜åŒ–ã€‚

![](/kata3.jpg)


containerdä¼šä¸kataçš„shimè¿›ç¨‹é€šä¿¡ï¼Œshimä¸agenté€šä¿¡ï¼Œagentåœ¨è™šæ‹Ÿæœºé‡Œé¢åšä¸€äº›äº‹æƒ…ï¼Œå¦‚é…ç½®ç½‘å¡ï¼Œå¯åŠ¨å®¹å™¨ç­‰ã€‚

> è™šæ‹ŸåŒ–æ–¹å¼

![](/kata4.jpg)

è¿™ä¸ªå›¾è™šçº¿å·¦è¾¹ä¸ç”¨çœ‹ï¼Œæœ¬è´¨å°±æ˜¯è°ƒç”¨qemuå‘½ä»¤åˆ›å»ºè™šæ‹Ÿæœºï¼Œå³è¾¹å®é™…ä¸Škataæ˜¯æŠŠk8s podè¿™ä¸ªå£³æœ¬æ¥æ˜¯å®¹å™¨ï¼Œæ¢æˆäº†è™šæ‹Ÿæœºï¼Œä½†æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚ï¼š
 1.  ç½‘ç»œä»»ç„¶åœ¨ä¸€ä¸ªnsä¸­ï¼Œä¸‹æ–‡ä¼šè®²
 2.  kata agentä¾ç„¶ä¼šåœ¨è™šæ‹Ÿæœºä¸­å¯åŠ¨å®¹å™¨

> kataç½‘ç»œ

![](/kata-net.jpg)

ç†Ÿæ‚‰dockeré»˜è®¤ç½‘ç»œæ¨¡å¼çš„äº²éƒ½æ¯”è¾ƒæ¸…æ¥šè®¾å¤‡å¯¹è¿˜æ²¡å˜ï¼Œè®¾å¤‡å¯¹çš„å¦å¤–ä¸€ç«¯ä¸è™šæ‹Ÿæœºè¿æ¥æ˜¯ç”±kataè´Ÿè´£ï¼Œç”¨çš„æŠ€æœ¯å«macvtapï¼Œå®ƒå¯ä»¥è®©ä¸€ä¸ªæ¥å£æ‹¥æœ‰å¤šä¸ªmacåœ°å€ã€‚

åˆ›å»ºmacvtapè®¾å¤‡ï¼š

```
ip link add link eth0 name macvtap0 type macvtap mode bridge
ip link set macvtap0 address 1a:46:0b:ca:bc:7b up
cat /sys/class/net/macvtap0/ifindex
cat /sys/class/net/macvtap0/address
é€šè¿‡qemuå¯åŠ¨ï¼š
qemu-system-x86_64 -enable-kvm centos.qcow2 \
 -cdrom CentOS-7-x86_64-Minimal-1810.iso \
 -netdev tap,fd=30,id=hostnet0,vhost=on,vhostfd=4 30<>/dev/tap2 4<>/dev/vhost-net \
 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=1a:46:0b:ca:bc:7b   \
 -monitor telnet:127.0.0.1:5801,server,nowait
VNC server running on ::1:5900
```

æ³¨æ„ç½‘ç»œå‚æ•°ï¼Œè¿™å—å¾ˆå°‘èµ„æ–™ä»‹ç»çš„æ¯”è¾ƒæ¸…æ¥šéƒ½æ˜¯å•¥å«ä¹‰ï¼Œæˆ‘ä¹Ÿæ˜¯é€šè¿‡å­¦ä¹ kataæºç é—®äº†å¾ˆå¤šå¤§ç‰›æ‰å½»åº•ç†è§£çš„ã€‚ 
/dev/tap2 è¿™ä¸ª2 æ˜¯é€šè¿‡ä¸Šé¢çš„ /sys/class/net/macvtap0/ifindex å·®å¾—çš„ã€‚
vhostæ˜¯è™šæ‹Ÿæœºç½‘ç»œè™šæ‹ŸåŒ–çš„ä¸€ç§æ¨¡å¼ï¼Œæ€§èƒ½æ¯”è¾ƒé«˜ï¼Œæˆ‘ä»¬éœ€è¦æŠŠvhostçš„fdä¼ å…¥ç»™qemu

å¯¹åº”kataçš„ä»£ç ï¼Œæœ¬è´¨å°±æ˜¯æ‰“å¼€äº†è¿™ä¸¤æ–‡ä»¶ï¼ŒæŠŠfdä¼ å…¥ï¼š

```
func createMacvtapFds(linkIndex int, queues int) ([]*os.File, error) {
  tapDev := fmt.Sprintf("/dev/tap%d", linkIndex)
  return createFds(tapDev, queues)
}

  fds := make([]*os.File, numFds)
  for i := 0; i < numFds; i++ {
    f, err := os.OpenFile(device, os.O_RDWR, defaultFilePerms)
    if err != nil {
      utils.CleanupFds(fds, i)
      return nil, err
    }
    fds[i] = f
  }
  return fds, nil
```

äº‹æƒ…è¿˜æ²¡ç»“æŸï¼Œè¿›å…¥è™šæ‹Ÿæœºä¼šå‘ç°ç½‘å¡æ²¡æœ‰åœ°å€ï¼š

```
[root@localhost ~]# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:59:ee:01 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::5054:ff:fe59:ee01/64 scope link 
       valid_lft forever preferred_lft forever
```

å› ä¸ºè™šæ‹Ÿæœºçš„eth0çš„åœ°å€æ˜¯kata-agentå»é…ç½®çš„ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è‡ªå·±åœ¨è™šæ‹Ÿæœºé…ç½®ä¸€ä¸‹ï¼Œipä¸€å®šè¦ä¸è®¾å¤‡å¯¹å¦ä¸€ç«¯çš„eth0ä¸€æ ·ã€‚

ç½‘ç»œå…¶å®ƒçš„éƒ¨åˆ†å°±æ˜¯å…¼å®¹CNIæ ‡å‡†äº†ï¼Œæœ¬æ–‡ä¸åšè¿‡å¤šä»‹ç»äº†ã€‚

> æ–‡ä»¶ç³»ç»ŸDAX(Direct Access filesystem) 
å†…æ ¸DAXåŠŸèƒ½æœ‰æ•ˆåœ°å°†ä¸€äº›ä¸»æœºç«¯æ–‡ä»¶æ˜ å°„åˆ°æ¥å®¾VMç©ºé—´ã€‚ç‰¹åˆ«æ˜¯Kata Containersä½¿ç”¨QEMU NVDIMMåŠŸèƒ½æä¾›å†…å­˜æ˜ å°„çš„è™šæ‹Ÿè®¾å¤‡ï¼Œå¯ç”¨äºå°†è™šæ‹Ÿæœºçš„æ ¹æ–‡ä»¶ç³»ç»ŸDAXæ˜ å°„åˆ°guestå†…å­˜åœ°å€ç©ºé—´ã€‚

![](/DAX.jpg)

çœ‹rootfsæ˜¯è¿™æ ·è¿‡å»çš„
QEMUé…ç½®äº†NVDIMMå†…å­˜è®¾å¤‡ï¼Œå†…å­˜æ–‡ä»¶åç«¯åœ¨ä¸»æœºç«¯æ–‡ä»¶ä¸­æ˜ å°„åˆ°è™šæ‹ŸNVDIMMç©ºé—´ã€‚
guestè™šæ‹Ÿæœºå†…æ ¸å‘½ä»¤è¡Œå®‰è£…æ­¤NVDIMMè®¾å¤‡å¹¶å¯ç”¨DAXåŠŸèƒ½ï¼Œå…è®¸ç›´æ¥é¡µé¢æ˜ å°„å’Œè®¿é—®ï¼Œä»è€Œç»•è¿‡guestè™šæ‹Ÿæœºé¡µé¢ç¼“å­˜ã€‚è¿™æ ·è™šæ‹Ÿæœºçš„æ ¹æ–‡ä»¶ç³»ç»Ÿå°±æ¥äº†ã€‚

> å†…æ ¸æ–‡ä»¶
kata kernel æ­¤è¿æ¥æœ‰è¯¦ç»†ä»‹ç»
1. kataå¯¹å†…æ ¸åšäº†ä¸€äº›patch,å¦‚å†…å­˜çƒ­æ’æ‹”ï¼Œ9pfsç¼“å­˜ä¼˜åŒ–ï¼Œarmæ¶æ„çš„æ›´å¥½æ”¯æŒç­‰
2. patchå®Œäº†åæŠŠç¼–è¯‘å¥½çš„å†…æ ¸æ”¾åˆ°kataæŒ‡å®šçš„ç›®å½•
make -j $(nproc) ARCH="${arch_target}"

> dockeré•œåƒè½¬åŒ–æˆè™šæ‹Ÿæœºé•œåƒ
osbuilderé¡¹ç›®ä¸“é—¨å»åšè¿™ä¸ªäº‹æƒ…ï¼Œè¿™é‡Œè¦è§£é‡Šçš„ä¸€ä¸ªæ¦‚å¿µæ˜¯initrdï¼ˆæˆ–â€œinitramfsâ€ï¼‰å‹ç¼©cpio(1)å½’æ¡£ï¼Œç”±rootfsåˆ›å»ºï¼ŒåŠ è½½åˆ°å†…å­˜ä¸­å¹¶ç”¨ä½œLinuxå¯åŠ¨è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚åœ¨å¯åŠ¨æœŸé—´ï¼Œå†…æ ¸å°†å…¶è§£å‹ç¼©åˆ°ä¸€ä¸ªç‰¹æ®Šçš„å®ä¾‹ä¸­ï¼Œè¯¥å®ä¾‹tmpfså°†æˆä¸ºåˆå§‹çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚
 
ä½¿ç”¨æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

> firecrackerç®€ä»‹

![](/firecracker.jpg)

ä¸ºä»€ä¹ˆæˆ‘è¿™ä¹ˆå–œæ¬¢firecrackerï¼Œå› ä¸ºä½ ä»¬ä¸€çœ‹å®ƒAPIå°±çŸ¥é“çš„ï¼Œç®€å•åˆ°è®©ä½ æ€€ç–‘äººç”Ÿï¼š
ä»¥ä¸‹æ˜¯ä¸ªç½‘ç»œçš„ä¾‹å­ï¼š

1. å®¿ä¸»æœºä¸Šåˆ›å»ºtapè®¾å¤‡

```
sudo ip tuntap add tap0 mode tap
sudo ip addr add 172.16.0.1/24 dev tap0
sudo ip link set tap0 up
sudo sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward"
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i tap0 -o eth0 -j ACCEPT
```

2. è°ƒç”¨APIåˆ›å»ºè™šæ‹Ÿæœºç½‘å¡

```
curl -X PUT \
  --unix-socket /tmp/firecracker.socket \
  http://localhost/network-interfaces/eth0 \
  -H accept:application/json \
  -H content-type:application/json \
  -d '{
      "iface_id": "eth0",
      "guest_mac": "AA:FC:00:00:00:01",
      "host_dev_name": "tap0"
    }'
```

3. é…ç½®è™šæ‹Ÿæœºç½‘å¡

```
ip addr add 172.16.0.2/24 dev eth0
ip route add default via 172.16.0.1 dev eth0
```

æ¸…æ¸…æ¥šæ¥šï¼Œå¹²å¹²å‡€å‡€

> è½»é‡çº§è™šæ‹Ÿæœºå…¶å®ƒ
ç°åœ¨è½»é‡çº§è™šæ‹Ÿæœºè¿˜æ˜¯æœ‰äº›é—®é¢˜æ²¡è§£å†³ï¼Œæ¯”å¦‚ç›‘æ§ï¼Œå°±ä¸èƒ½åƒcadvisoré‚£æ ·å»ç›‘æ§å®¹å™¨äº†ï¼Œæ‰€ä»¥è¿™å—kubeleté‡‡é›†çš„åœ°æ–¹å°±éœ€è¦å®šåˆ¶ã€‚

> kubevirtç®€ä»‹
ä»¥ä¸Šéƒ½æ˜¯è½»é‡çº§è™šæ‹Ÿæœºï¼Œç„¶è€Œå¯¹äºäº¡openstackä¹‹å¿ƒä¸æ­»çš„äººè¿˜æ˜¯å¸Œæœ›æå‡ºä¸ªèƒ½ç®¡ç†é‡é‡çº§è™šæ‹Ÿæœºçš„ä¸œè¥¿ï¼Œkubevirtåº”è¿è€Œç”Ÿã€‚ 

æˆ‘ä»¬å¦‚æœå»åŸºæœ¬kataå»ç®¡ç†æœ‰çŠ¶æ€çš„é‡é‡çº§è™šæ‹Ÿæœºå…¶å®è¿˜æ˜¯æœ‰å¾ˆå¤šäº‹è¦å»åšçš„ï¼š
ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œk8så¯æ²¡æœ‰å¯åŠ¨åœæ­¢å®¹å™¨è¿™äº›æ¦‚å¿µï¼Œæ‰€ä»¥æƒ³è¦æ”¯æŒè™šæ‹Ÿæœºçš„å¯åŠ¨é‡å¯å°±å¾—è‡ªå·±å»å®šä¹‰CRDï¼Œç„¶åè¿˜ä¸å¤Ÿï¼Œå› ä¸ºkubeletä¸ä¼šå»è°ƒç”¨CRIçš„å¯åŠ¨åœæ­¢çš„æ¥å£ï¼Œæ‰€ä»¥è¿˜å¾—ä¿®æ”¹kubelet...
ç½‘ç»œï¼Œä¸€èˆ¬çš„CNIæ˜¯æ»¡è¶³ä¸äº†IPæ¼‚ç§»ä»¥åŠVPCè¿™ç§éœ€æ±‚çš„ï¼Œæ‰€ä»¥ä½ éœ€è¦ovn CNIä¹‹ç±»çš„ä¸œè¥¿
è™šæ‹Ÿæœºçš„ç³»ç»Ÿç›˜æ•°æ®ç›˜æ”¾æœ¬åœ°æ˜¯ä¸è¡Œäº†ï¼Œæ”¹ã€‚ã€‚ã€‚
å…¼å®¹openstacké‚£äº›ç³»ç»Ÿé•œåƒï¼Œæ”¹ã€‚ã€‚ã€‚

kubevirtæ­£æ˜¯å› ä¸ºè¿™ä¸ªé—®é¢˜æ‰€ä»¥é‡‡ç”¨äº†è¿™æ ·çš„æ¶æ„ï¼š

![](/kubevirt.jpg)

ä»…èµ„æºè°ƒåº¦æ—¶èµ°k8sï¼Œè™šæ‹Ÿæœºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†åŸºæœ¬å·²ç»ä¸CRIæ²¡å…³ç³»äº†ï¼Œå…¨èµ°è‡ªå·±çš„agentç®¡ç†ï¼Œè¿™æ ·ä¸Šé¢çš„é‚£äº›é—®é¢˜éƒ½å¯ä»¥åœ¨virt-handler virt-laucherä¸Šè§£å†³ï¼Œä¸ç”¨å†å»å¯¹k8sç»„ä»¶åŠ¨åˆ€ã€‚

æœ¬è´¨å°±æ˜¯åœ¨å®¹å™¨é‡Œèµ·äº†ä¸ªè™šæ‹Ÿæœºï¼Œä¸è¿‡å¯åŠ¨æ–¹å¼ä¸kataæœ‰æ‰€ä¸åŒï¼Œå®ƒä½¿ç”¨äº†libvirtï¼Œqemuæ›´ä¸Šå±‚çš„ä¸€ä¸ªå°è£…ï¼Œå½“ç„¶ç©é‡é‡çº§è™šæ‹Ÿæœºæœ‰è¿™ä¸ªè¿˜æ˜¯æ–¹ä¾¿å¾ˆå¤šçš„ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦è°ƒè¯•ï¼Œæˆ–è€…æ‰¾é”™è¯¯ï¼Œlibvirtç»™äº†ä¸€ç³»åˆ—çš„å·¥å…·é›†ï¼ŒåŒæ—¶ä¹Ÿå¯¹ç¼–ç¨‹å‹å¥½ã€‚

ä¸è¿‡æ¯ä¸ªè™šæ‹Ÿæœºéƒ½ä¼šå»èµ·ä¸€ä¸ªlibvirtdè¿›ç¨‹çš„åšæ³•æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰å¾…å•†æ¦·ã€‚

> æ€»ç»“
æœ¬æ–‡è™½ç„¶æ‰¯äº†å¾ˆå¤šï¼Œä½†æ˜¯è™šæ‹Ÿæœºè¿˜æ˜¯è¿œæ¯”å®¹å™¨å¤æ‚ï¼Œæœ¬æ–‡ä¹Ÿåªèƒ½æä¸ªå†°å±±ä¸€è§’ï¼Œå¸Œæœ›å¤§å®¶è¯»å®Œèƒ½æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†ã€‚æˆ‘æ˜¯å¸Œæœ›èƒ½ç”¨ä¸€ä¸ªç»Ÿä¸€çš„æŠ€æœ¯æ ˆæå®šå®¹å™¨ï¼Œè™šæ‹Ÿæœºï¼Œè½»é‡çº§è™šæ‹Ÿæœºï¼Œè¿™æ ·èƒ½æå¤§çš„èŠ‚çœä¼ä¸šçš„æˆæœ¬ï¼Œå°¤å…¶æ˜¯äººåŠ›ç»´æŠ¤æˆæœ¬ã€‚ 

