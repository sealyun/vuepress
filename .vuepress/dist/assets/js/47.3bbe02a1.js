(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{246:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"从cni到ovn"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从cni到ovn"}},[s._v("#")]),s._v(" 从CNI到ovn")]),s._v(" "),a("p",[s._v("诸如calico flannel等CNI实现，通过牺牲一些功能让网络复杂度得以大幅度降低是我极其推崇的，在云原生时代应用不再关心基础设施的场景下是一个明智之举，给网络调错带来了极大方便。")]),s._v(" "),a("p",[s._v("openstack与k8s放一起比较意义不大，openstack还是着重与基础设施，所以对上接口还是机器设施，网络设施，存储设施等，着重与资源的抽象。")]),s._v(" "),a("p",[s._v("然鹅k8s不仅需要资源抽象，还需要关心应用的管理，其基于容器的设计理念已经改变了传统三层的云计算架构，而更像一个云内核，对上不再关心基础设施的接口了，反正把用户应用管好了就行。")]),s._v(" "),a("p",[s._v("对比早起的操作系统很发现历史是惊人的相似，早期分层式操作系统到现代的宏内核与微内核操作系统，系统设计更为内聚了。目测云操作系统也会朝着这个路子发展吧（openstack粉太多，亡openstack之心不死不敢直说）")]),s._v(" "),a("p",[s._v("但是！")]),s._v(" "),a("p",[s._v("openstack底层一些技术还是非常值得学习与应用的，如qemu kvm ovs ovn ceph DPDK等。。。")]),s._v(" "),a("p",[s._v("本文重点讲网络这块,ovn ovs怎么与kubernetes擦出火花\n")]),s._v(" "),a("h1",{attrs:{id:"cni原理简述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cni原理简述"}},[s._v("#")]),s._v(" CNI原理简述")]),s._v(" "),a("p",[s._v("CNI不是本文的重点，这里仅做一下简单的介绍"),a("a",{attrs:{href:"https://github.com/containernetworking/cni/blob/master/SPEC.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("更多详情"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("CNI很简单，本质就是你实现一个命令行工具，kubelet初始化网络时会去调用这个工具，传入一些环境变量，然后根据环境变量工具去做网络配置：")]),s._v(" "),a("p",[s._v("配置完成后标准输出一个CNI规定的json格式，告诉k8s你的IP地址啥的")]),s._v(" "),a("p",[s._v("命令包含三个部分")]),s._v(" "),a("ul",[a("li",[s._v("ADD 创建网络")]),s._v(" "),a("li",[s._v("DEL 删除网络")]),s._v(" "),a("li",[s._v("CHECK 检查网络")])]),s._v(" "),a("p",[s._v("这里对ADD做一个介绍：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('EnvCNIPath        = "CNI_PATH"\nEnvNetDir         = "NETCONFPATH"\nEnvCapabilityArgs = "CAP_ARGS"\nEnvCNIArgs        = "CNI_ARGS"\nEnvCNIIfname      = "CNI_IFNAME" # 网卡名\n\nDefaultNetDir = "/etc/cni/net.d"\n\nCmdAdd   = "add"\nCmdCheck = "check"\nCmdDel   = "del"\n')])])]),a("p",[s._v("入参：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("容器ID\n网络namespace目录\n网络配置 - 定义哪些容器可以join到此网络\n容器内网卡名\n额外参数\n")])])]),a("p",[s._v("标准输出类似这样一个json：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{\n  "cniVersion": "0.4.0",\n  "interfaces": [                                            (this key omitted by IPAM plugins)\n      {\n          "name": "<name>",\n          "mac": "<MAC address>",                            (required if L2 addresses are meaningful)\n          "sandbox": "<netns path or hypervisor identifier>" (required for container/hypervisor interfaces, empty/omitted for host interfaces)\n      }\n  ],\n  "ips": [\n      {\n          "version": "<4-or-6>",\n          "address": "<ip-and-prefix-in-CIDR>",\n          "gateway": "<ip-address-of-the-gateway>",          (optional)\n          "interface": <numeric index into \'interfaces\' list>\n      }\n...\n')])])]),a("p",[s._v("那比如想拿到pod的一些元数据怎么办，典型场景是比如pod yaml里定义了属于哪个子网啥的，对不起CNI不传给你，你得拿着podid去apiserver里查，这是一个非常不爽的地方，所以现在ovn的CNI都有一个CNI server的东西去和apiserver交互。")]),s._v(" "),a("p",[s._v("我去实现的话会考虑把信息写到容器的label里，这样CNI工具直接去容器元数据里查找一些信息,少用一个server")]),s._v(" "),a("h1",{attrs:{id:"ovs与ovn安装与配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ovs与ovn安装与配置"}},[s._v("#")]),s._v(" OVS与OVN安装与配置")]),s._v(" "),a("h2",{attrs:{id:"编译安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译安装"}},[s._v("#")]),s._v(" 编译安装")]),s._v(" "),a("p",[s._v("(吐槽一下ovn写的shit一般的文档)")]),s._v(" "),a("p",[s._v("推荐用源码安装"),a("a",{attrs:{href:"http://www.openvswitch.org//download/",target:"_blank",rel:"noopener noreferrer"}},[s._v("地址"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("wget https://www.openvswitch.org/releases/openvswitch-2.11.1.tar.gz\ntar zxvf openvswitch-2.11.1.tar.gz\ncd openvswitch-2.11.1\n./boot.sh && ./configure && make && make install\n")])])]),a("p",[s._v("有个ovn的"),a("a",{attrs:{href:"http://docs.openvswitch.org/en/latest/tutorials/ovn-sandbox/",target:"_blank",rel:"noopener noreferrer"}},[s._v("sandbox"),a("OutboundLink")],1),s._v(" 可以这样make : "),a("code",[s._v('make sandbox SANDBOXFLAGS="--ovn"')]),s._v(" 太低级咱不玩")]),s._v(" "),a("p",[s._v("如果编译内核模块：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$ make modules_install\n$ config_file="/etc/depmod.d/openvswitch.conf"\n$ for module in datapath/linux/*.ko; do\n  modname="$(basename ${module})"\n  echo "override ${modname%.ko} * extra" >> "$config_file"\n  echo "override ${modname%.ko} * weak-updates" >> "$config_file"\n  done\n$ depmod -a\n$ /sbin/modprobe openvswitch\n$ /sbin/lsmod | grep openvswitch\n')])])]),a("h2",{attrs:{id:"启动ovs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动ovs"}},[s._v("#")]),s._v(" 启动ovs")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$ export PATH=$PATH:/usr/local/share/openvswitch/scripts\n$ ovs-ctl start --system-id="random"\n$ ovs-appctl -t ovsdb-server ovsdb-server/add-remote ptcp:6640:IP_ADDRESS # 开启远程数据库\n')])])]),a("p",[s._v("IP_ADDRESS 是控制节点管理网地址")]),s._v(" "),a("h2",{attrs:{id:"验证ovs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证ovs"}},[s._v("#")]),s._v(" 验证ovs")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ ovs-vsctl add-br br0\n$ ovs-vsctl add-port br0 eth0\n$ ovs-vsctl add-port br0 vif1.0\n$ ovs-vsctl show\n")])])]),a("h2",{attrs:{id:"启动ovn"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动ovn"}},[s._v("#")]),s._v(" 启动ovn")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ /usr/share/openvswitch/scripts/ovn-ctl start_northd # 启动北向数据库\n$ /usr/share/openvswitch/scripts/ovn-ctl start_controller # 启动ovn controller\n$ ovn-sbctl show # 验证\n$ ovn-nbctl show # 验证\n")])])]),a("h2",{attrs:{id:"配置ovs与ovn相连接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置ovs与ovn相连接"}},[s._v("#")]),s._v(" 配置ovs与ovn相连接")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# ovn-nbctl set-connection ptcp:6641:0.0.0.0 -- \\\n            set connection . inactivity_probe=60000\n# ovn-sbctl set-connection ptcp:6642:0.0.0.0 -- \\\n            set connection . inactivity_probe=60000\n# if using the VTEP functionality:\n#   ovs-appctl -t ovsdb-server ovsdb-server/add-remote ptcp:6640:0.0.0.0\n")])])]),a("p",[s._v("配置ovsdb-server模块，默认ovsdb-server只允许本地访问，ovn服务需要这个权限。")]),s._v(" "),a("h2",{attrs:{id:"配置ovs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置ovs"}},[s._v("#")]),s._v(" 配置ovs")]),s._v(" "),a("p",[s._v("controller节点使用ovs databases")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ovs-vsctl set open . external-ids:ovn-remote=tcp:IP_ADDRESS:6642\novs-vsctl set open . external-ids:ovn-encap-type=geneve,vxlan # 配置封装类型，geneve比较吊\novs-vsctl set open . external-ids:ovn-encap-ip=IP_ADDRESS # 配置overlay endpoint地址\n")])])]),a("h1",{attrs:{id:"ovs与容器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ovs与容器"}},[s._v("#")]),s._v(" OVS与容器")]),s._v(" "),a("p",[a("img",{attrs:{src:"/ovn-cni.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"ovs单机连通性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ovs单机连通性"}},[s._v("#")]),s._v(" ovs单机连通性")]),s._v(" "),a("p",[s._v("创建容器, 设置net=none可以防止docker0默认网桥影响连通性测试")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker run -itd --name con6 --net"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("none ubuntu:14.04 /bin/bash\ndocker run -itd --name con7 --net"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("none ubuntu:14.04 /bin/bash\ndocker run -itd --name con8 --net"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("none ubuntu:14.04 /bin/bash\n")])])]),a("p",[s._v("创建网桥")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("ovs-vsctl add-br ovs0\n")])])]),a("p",[s._v("使用ovs-docker给容器添加网卡，并挂到ovs0网桥上")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("ovs-docker add-port ovs0 eth0 con6 --ipaddress"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2/24\novs-docker add-port ovs0 eth0 con7 --ipaddress"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3/24\novs-docker add-port ovs0 eth0 con8 --ipaddress"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.4/24\n")])])]),a("p",[s._v("查看网桥")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl show")]),s._v("\n21e4d4c5-cadd-4dac-b025-c20b8108ad09\n    Bridge "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b167e3dcf8db4_l"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b167e3dcf8db4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n                type: internal\n    ovs_version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.8.2"')]),s._v("\n")])])]),a("p",[s._v("测试连通性")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it con8 sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.2      ")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.886")]),s._v(" ms\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 0ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.886")]),s._v("/0.886/0.886/0.000 ms\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.3  ")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.712")]),s._v(" ms\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 0ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.712")]),s._v("/0.712/0.712/0.000 ms\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("h3",{attrs:{id:"设置vlan-tag"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置vlan-tag"}},[s._v("#")]),s._v(" 设置VLAN tag")]),s._v(" "),a("p",[s._v("查看网桥")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl show")]),s._v("\n21e4d4c5-cadd-4dac-b025-c20b8108ad09\n    Bridge "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b167e3dcf8db4_l"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b167e3dcf8db4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n                type: internal\n    ovs_version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.8.2"')]),s._v("\n")])])]),a("p",[s._v("Interface是openvswitch核心概念之一，对应模拟的是交换机中插入port的网卡设备。一个Port通常只能有一个interface，但也可以有多个interfaces(Bond).")]),s._v(" "),a("p",[s._v("interface type")]),s._v(" "),a("ul",[a("li",[s._v("system(如eth0),比如想把系统上的网卡挂在网桥上")]),s._v(" "),a("li",[s._v("internal(模拟网络设备，名字如果是和bridge的名字一样则叫local interface)")]),s._v(" "),a("li",[s._v("tap(一个tun/tap设备)")]),s._v(" "),a("li",[s._v("patch(一对虚拟设备，用来模拟插线电缆) 容器场景用的多")]),s._v(" "),a("li",[s._v("geneve(以太网通过geneve隧道)")]),s._v(" "),a("li",[s._v("gre(RFC2890)，ipsec_gre(RFC2890 over ipsec tunnel)")]),s._v(" "),a("li",[s._v("vxlan(基于以UDP为基础的VXLAN协议上的以太网隧道)")]),s._v(" "),a("li",[s._v("lisp(一个3层的隧道，还在实验阶段)")]),s._v(" "),a("li",[s._v("stt（Stateless TCP Tunnel，）")])]),s._v(" "),a("p",[s._v("查看interface")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl list interface f1c0a9d0994d4_l")]),s._v("\n_uuid               "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" cf400e7c-d2d6-4e0a-ad02-663dd63d1751\nadmin_state         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" up\nduplex              "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" full\nerror               "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nexternal_ids        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("container_id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"con6"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_iface")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eth0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nifindex             "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("239")]),s._v("\ningress_policing_burst: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ningress_policing_rate: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nlacp_current        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nlink_resets         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nlink_speed          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000000000")]),s._v("\nlink_state          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" up\nmac_in_use          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"96:91:0a:c9:02:d6"')]),s._v("\nmtu                 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("\nmtu_request         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nname                "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\nofport              "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\nother_config        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nstatistics          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("collisions"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rx_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1328")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rx_crc_err")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rx_dropped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rx_errors")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rx_frame_err")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rx_over_err")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rx_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tx_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3032")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tx_dropped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tx_errors")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tx_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nstatus              "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("driver_name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("veth, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("driver_version")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.0"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("firmware_version")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v("                "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n")])])]),a("p",[s._v("设置vlan tag")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("ovs-vsctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" port   f1c0a9d0994d4_l "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  //con6\novs-vsctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" port   b167e3dcf8db4_l "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  //con8\novs-vsctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" port   121c6b2f221c4_l "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("  //con7\n")])])]),a("p",[s._v("测试连通性")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it con8 sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.2 -c 3")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.413")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.061")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.057")]),s._v(" ms\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 2044ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.057")]),s._v("/0.177/0.413/0.166 ms\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.3 -c 3")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\nFrom "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.4 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" Destination Host Unreachable\nFrom "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.4 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" Destination Host Unreachable\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" received, +3 errors, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 2068ms\npipe "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("h2",{attrs:{id:"跨主机连通性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跨主机连通性"}},[s._v("#")]),s._v(" 跨主机连通性")]),s._v(" "),a("h3",{attrs:{id:"环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[s._v("#")]),s._v(" 环境")]),s._v(" "),a("h5",{attrs:{id:"host1-172-29-101-123"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#host1-172-29-101-123"}},[s._v("#")]),s._v(" host1 172.29.101.123")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("网桥:  ovs0      \n\n容器:    \ncon6  192.168.1.2   \ncon7  192.168.1.3   \ncon8  192.168.1.4   \n")])])]),a("p",[s._v("创建方式依上")]),s._v(" "),a("h5",{attrs:{id:"host2-172-29-101-82"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#host2-172-29-101-82"}},[s._v("#")]),s._v(" host2 172.29.101.82")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("网桥: ovs1\n\n容器: con11\n")])])]),a("p",[s._v("准备环境")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("创建网桥\novs-vsctl add-br ovs1\n\n创建容器\ndocker run -itd --name con11 --net"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("none ubuntu:14.04 /bin/bash\n\n挂到ovs0网桥\novs-docker add-port ovs1 eth0 con11 --ipaddress"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6/24\n")])])]),a("p",[s._v("查看网桥ovs1")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl show")]),s._v("\n380ce027-8edf-4844-8e89-a6b9c1adaff3\n    Bridge "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs1"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0384251973e64_l"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0384251973e64_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs1"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs1"')]),s._v("\n                type: internal\n    ovs_version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.8.2"')]),s._v("\n")])])]),a("h3",{attrs:{id:"设置vxlan"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置vxlan"}},[s._v("#")]),s._v(" 设置vxlan")]),s._v(" "),a("p",[s._v("在host1上")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl add-port ovs0 vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=172.29.101.82 options:key=flow")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl show")]),s._v("\n21e4d4c5-cadd-4dac-b025-c20b8108ad09\n    Bridge "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b167e3dcf8db4_l"')]),s._v("\n            tag: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b167e3dcf8db4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n            tag: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n            tag: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n                type: internal\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vxlan1"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vxlan1"')]),s._v("\n                type: vxlan\n                options: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("flow, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("remote_ip")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.29.101.82"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    ovs_version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.8.2"')]),s._v("\n")])])]),a("p",[s._v("在host2上")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl add-port ovs1 vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=172.29.101.123 options:key=flow")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl show")]),s._v("\n380ce027-8edf-4844-8e89-a6b9c1adaff3\n    Bridge "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs1"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0384251973e64_l"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0384251973e64_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vxlan1"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vxlan1"')]),s._v("\n                type: vxlan\n                options: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("flow, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("remote_ip")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.29.101.123"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs1"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs1"')]),s._v("\n                type: internal\n    ovs_version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.8.2"')]),s._v("\n")])])]),a("h3",{attrs:{id:"设置vlan-tag-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置vlan-tag-2"}},[s._v("#")]),s._v(" 设置vlan tag")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("ovs-vsctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" port 0384251973e64_l "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])])]),a("h3",{attrs:{id:"连通性测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#连通性测试"}},[s._v("#")]),s._v(" 连通性测试")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -ti con11 bash")]),s._v("\nroot@c82da61bf925:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.2")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.161")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.206")]),s._v(" ms\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 1000ms\nroot@c82da61bf925:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@c82da61bf925:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.3")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 2027ms\nroot@c82da61bf925:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@c82da61bf925:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# exit")]),s._v("\n")])])]),a("h3",{attrs:{id:"结论"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),a("p",[s._v("vxlan只能连通两台机器的ovs上同一个网段的容器，无法连通ovs上不同网段的容器。如果需要连通不同网段的容器，接下来我们尝试通过ovs的流表来解决这个问题。")]),s._v(" "),a("h1",{attrs:{id:"openflow"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#openflow"}},[s._v("#")]),s._v(" OpenFlow")]),s._v(" "),a("h3",{attrs:{id:"flow-table"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#flow-table"}},[s._v("#")]),s._v(" flow table")]),s._v(" "),a("p",[s._v("支持openflow的交换机中可能包含多个flow table。每个flow table包含多条规则，每条规则包含匹配条件和执行动作。flow table中的每条规则有优先级，优先级高的优先匹配，匹配到规则以后，执行action，如果匹配失败，按优先级高低，继续匹配下一条。如果都不匹配，每张表会有默认的动作，一般为drop或者转给下一张流表。")]),s._v(" "),a("h3",{attrs:{id:"实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实践"}},[s._v("#")]),s._v(" 实践")]),s._v(" "),a("h4",{attrs:{id:"环境-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境-2"}},[s._v("#")]),s._v(" 环境")]),s._v(" "),a("p",[s._v("host1 172.29.101.123")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("网桥:  ovs0      \n\n容器:    \ncon6  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2     "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\ncon7  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3     "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])])]),a("p",[s._v("host2 172.29.101.82")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("网桥: ovs1\n\n容器:  \ncon9:  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.2    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\ncon10：192.168.2.3    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\ncon11: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.5    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])])]),a("h3",{attrs:{id:"查看默认流表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看默认流表"}},[s._v("#")]),s._v(" 查看默认流表")]),s._v(" "),a("p",[s._v("在host1上查看默认流表")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller msxu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-ofctl dump-flows ovs0")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27858")]),s._v(".050s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5253660876")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("371729202788")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NORMAL\n")])])]),a("p",[s._v("在容器con6中ping con7，网络连通")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -ti con6 bash")]),s._v("\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.3")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.613")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.066")]),s._v(" ms\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 1058ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.066")]),s._v("/0.339/0.613/0.274 ms\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("p",[s._v("删除默认流表")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-ofctl del-flows ovs0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-ofctl dump-flows ovs0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("p",[s._v("测试网络连通性，发现网络已经不通")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -ti con6 bash")]),s._v("\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.3")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 1025ms\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("h3",{attrs:{id:"添加流表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加流表"}},[s._v("#")]),s._v(" 添加流表")]),s._v(" "),a("p",[s._v("如果要con6和con7能够通信，需要建立规则，让ovs转发对应的数据")]),s._v(" "),a("p",[s._v("查看con6和con7在ovs上的网络端口")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl show")]),s._v("\n21e4d4c5-cadd-4dac-b025-c20b8108ad09\n    Bridge "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n            tag: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n            tag: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovs0"')]),s._v("\n                type: internal\n        Port "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vxlan1"')]),s._v("\n            Interface "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vxlan1"')]),s._v("\n                type: vxlan\n                options: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("flow, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("remote_ip")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.29.101.82"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    ovs_version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.8.2"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl list interface f1c0a9d0994d4_l |grep ofport")]),s._v("\nofport              "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\nofport_request      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-vsctl list interface 121c6b2f221c4_l |grep ofport")]),s._v("\nofport              "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\nofport_request      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),a("p",[s._v("添加规则：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#ovs-ofctl add-flow ovs0 "priority=1,in_port=3,actions=output:4"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#ovs-ofctl add-flow ovs0 "priority=2,in_port=4,actions=output:3"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-ofctl dump-flows ovs0")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(".440s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("output:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(".791s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("output:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])])]),a("p",[s._v("测试连通性：con6和con7已通")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller msxu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -ti con6 bash")]),s._v("\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.3")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.924")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.058")]),s._v(" ms\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 1057ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.058")]),s._v("/0.491/0.924/0.433 ms\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("p",[s._v("设置一条优先级高的规则：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ovs-ofctl add-flow ovs0 "priority=2,in_port=4,actions=drop"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -ti con6 bash")]),s._v("\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping  192.168.1.3")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 2087ms\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@9ccc5c5664f9:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("p",[s._v("流表中的规则是有优先级的，priority数值越大，优先级越高。流表中，优先级高的优先匹配，并执行匹配规则的actions。如果不匹配，继续匹配优先级低的下一条。")]),s._v(" "),a("h3",{attrs:{id:"跨网段连通"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跨网段连通"}},[s._v("#")]),s._v(" 跨网段连通")]),s._v(" "),a("p",[s._v("在上一个vxlan的实践中，通过设置vxlan可以打通两个机器上的ovs，但我们提到两个机器ovs上的容器得在同一个网段上才能通信。")]),s._v(" "),a("p",[s._v("在ip为192.168.2.2的con9上ping另一台机上的con6 192.168.1.2")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -ti con9 bash")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.2")]),s._v("\nconnect: Network is unreachable\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("h4",{attrs:{id:"添加流表规则："}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加流表规则："}},[s._v("#")]),s._v(" 添加流表规则：")]),s._v(" "),a("p",[s._v("在host1上：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ovs-ofctl add-flow ovs0 "priority=4,in_port=6,actions=output:3"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ovs-ofctl add-flow ovs0 "priority=4,in_port=3,actions=output:6"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-ofctl dump-flows ovs0")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3228")]),s._v(".737s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("490")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("output:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3215")]),s._v(".544s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("output:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3168")]),s._v(".297s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("546")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"121c6b2f221c4_l"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("drop\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(".024s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("vxlan1 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("output:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".168s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"f1c0a9d0994d4_l"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("output:vxlan1\n\n")])])]),a("p",[s._v("在host2上")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ovs-ofctl add-flow ovs1 "priority=1,in_port=1,actions=output:6"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ovs-ofctl add-flow ovs1 "priority=1,in_port=6,actions=output:1"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ovs-ofctl dump-flows ovs1")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1076")]),s._v(".522s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1134")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0384251973e64_l"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("output:vxlan1\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("936")]),s._v(".403s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",in_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("vxlan1 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("output:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0384251973e64_l"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x0, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("70205")]),s._v(".443s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_packets")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7325")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("n_bytes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("740137")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("actions")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NORMAL\n\n")])])]),a("h4",{attrs:{id:"测试连通性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试连通性"}},[s._v("#")]),s._v(" 测试连通性")]),s._v(" "),a("p",[s._v("在host2 con9上ping 192.168.1.2")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -ti con9 bash")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.2")]),s._v("\nconnect: Network is unreachable\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("p",[s._v("发现网络并不通，查看发现路由规则有问题，添加默认路由规则，注意这里需要已privileged权限进入容器")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec --privileged -ti con9 bash")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# route -n")]),s._v("\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.0     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0   U     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" eth0\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# route add default dev eth0")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# route -n")]),s._v("\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0         U     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" eth0\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.0     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0   U     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" eth0\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])])]),a("p",[s._v("在host1和host2的容器中都添加好路由规则后，测试连通性")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute82 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec --privileged -ti con9 bash")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@b55602aad0ac:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.1.2")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.16")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.314")]),s._v(" ms\n^C\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 1002ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.314")]),s._v("/0.739/1.165/0.426 ms\n")])])]),a("p",[s._v("已成功通过ovs，vxlan打通两台机器上不同网段容器")]),s._v(" "),a("h1",{attrs:{id:"ovn实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ovn实践"}},[s._v("#")]),s._v(" OVN实践")]),s._v(" "),a("p",[s._v("有了ovs相关的实践，就具备了一定的基础，下面就可以进一步去了解ovn，ovn很重要的一点就是理解逻辑交换机,ovn是管控层面的，比如每台机器上都起了一个ovs交换机（软交换机，或者相对于逻辑交换机称之为物理交换机) 分布在不同机器上的虚拟机想要在一个子网下，那么我们创建一个逻辑交换机，把机器interface与之逻辑上关联在一起即可，最终ovn会下发流表使其在一个子网下。")]),s._v(" "),a("h2",{attrs:{id:"基本使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本使用"}},[s._v("#")]),s._v(" 基本使用")]),s._v(" "),a("h3",{attrs:{id:"逻辑面（控制面）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#逻辑面（控制面）"}},[s._v("#")]),s._v(" 逻辑面（控制面）")]),s._v(" "),a("p",[s._v("创建俩逻辑交换机")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$ ovn-nbctl ls-add sw0\n$ ovn-nbctl lsp-add sw0 sw0-port1\n$ ovn-nbctl lsp-set-addresses sw0-port1 "50:54:00:00:00:01 192.168.0.2"\n\n$ ovn-nbctl ls-add sw1\n$ ovn-nbctl lsp-add sw1 sw1-port1\n$ ovn-nbctl lsp-set-addresses sw1-port1 "50:54:00:00:00:03 11.0.0.2"\n')])])]),a("p",[s._v("创建一个逻辑路由器，并把两个交换机连接到路由器上")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ ovn-nbctl lr-add lr0\n$ ovn-nbctl lrp-add lr0 lrp0 00:00:00:00:ff:01 192.168.0.1/24\n$ ovn-nbctl lsp-add sw0 lrp0-attachment\n$ ovn-nbctl lsp-set-type lrp0-attachment router\n$ ovn-nbctl lsp-set-addresses lrp0-attachment 00:00:00:00:ff:01\n$ ovn-nbctl lsp-set-options lrp0-attachment router-port=lrp0\n$ ovn-nbctl lrp-add lr0 lrp1 00:00:00:00:ff:02 11.0.0.1/24\n\n$ ovn-nbctl lsp-add sw1 lrp1-attachment\n$ ovn-nbctl lsp-set-type lrp1-attachment router\n$ ovn-nbctl lsp-set-addresses lrp1-attachment 00:00:00:00:ff:02\n$ ovn-nbctl lsp-set-options lrp1-attachment router-port=lrp1\n")])])]),a("p",[s._v("查看逻辑配置：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$ ovn-nbctl show\n    switch 1396cf55-d176-4082-9a55-1c06cef626e4 (sw1)\n        port lrp1-attachment\n            addresses: ["00:00:00:00:ff:02"]\n        port sw1-port1\n            addresses: ["50:54:00:00:00:03 11.0.0.2"]\n    switch 2c9d6d03-09fc-4e32-8da6-305f129b0d53 (sw0)\n        port lrp0-attachment\n            addresses: ["00:00:00:00:ff:01"]\n        port sw0-port1\n            addresses: ["50:54:00:00:00:01 192.168.0.2"]\n    router f8377e8c-f75e-4fc8-8751-f3ea03c6dd98 (lr0)\n        port lrp0\n            mac: "00:00:00:00:ff:01"\n            networks: ["192.168.0.1/24"]\n        port lrp1\n            mac: "00:00:00:00:ff:02"\n            networks: ["11.0.0.1/24"]\n')])])]),a("p",[s._v("使用ovn-trace:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$ ovn-trace --minimal sw0 \'inport == "sw0-port1" \\\n> && eth.src == 50:54:00:00:00:01 && ip4.src == 192.168.0.2 \\\n> && eth.dst == 00:00:00:00:ff:01 && ip4.dst == 11.0.0.2 \\\n> && ip.ttl == 64\'\n\n# ip,reg14=0x1,vlan_tci=0x0000,dl_src=50:54:00:00:00:01,dl_dst=00:00:00:00:ff:01,nw_src=192.168.0.2,nw_dst=11.0.0.2,nw_proto=0,nw_tos=0,nw_ecn=0,nw_ttl=64\nip.ttl--;\neth.src = 00:00:00:00:ff:02;\neth.dst = 50:54:00:00:00:03;\noutput("sw1-port1");\n')])])]),a("p",[s._v("这里我们指定了源地址与源端口，再指定目的ip，最后会输出告诉我们从交换机哪个端口发出去了。")]),s._v(" "),a("h3",{attrs:{id:"重点-把容器挂到逻辑交换机上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重点-把容器挂到逻辑交换机上"}},[s._v("#")]),s._v(" 重点: 把容器挂到逻辑交换机上")]),s._v(" "),a("p",[s._v("ovs-docker这个工具里有这样一句：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('ip link add "${PORTNAME}_l" type veth peer name "${PORTNAME}_c"\n\n# Add one end of veth to OVS bridge.\nif ovs_vsctl --may-exist add-port "$BRIDGE" "${PORTNAME}_l" \\\n       -- set interface "${PORTNAME}_l" \\\n')])])]),a("p",[s._v("先创建了一个设备对，然后把设备对一端设置成ovs上的一个interface, 这样容器与ovs就关联上了，再把这个ovs上的port与ovn逻辑子网进行关联即可，请看具体例子：")]),s._v(" "),a("p",[s._v("启动容器后是先要把容器设备对的一端挂在物理交换机上，然后通过设置iface-id来与逻辑交换机进行关联。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ovs-vsctl --may-exist add-port sw0 port0 -- set interface port0 # 把docker挂到ovs上\novs-vsctl set Interface port0 external_ids:iface-id=lpor0       # 通过iface-id关联到逻辑端口上\n")])])]),a("p",[s._v("具体代码可以查看"),a("a",{attrs:{href:"https://github.com/fanux/ops/blob/master/ovs/ovn/lib/ovn.sh",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),a("OutboundLink")],1),s._v(" 这封装了一些基操作")]),s._v(" "),a("p",[s._v("一些具体实现："),a("a",{attrs:{href:"https://github.com/fanux/ops/blob/master/ovs/ovn/l2_basic.sh",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用教程"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"逻辑子网"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#逻辑子网"}},[s._v("#")]),s._v(" 逻辑子网")]),s._v(" "),a("p",[s._v("这里创建四个端口，都挂在ovs br-int网桥上，但是分别属于不同的逻辑交换机，这样不同的逻辑交换机没有连接路由器的情况下是不通的，同一个逻辑子网下端口可以互通。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ls-create sw0\nls-add-port sw0 sw0-port1 00:00:00:00:00:01 192.168.33.10/24\nls-add-port sw0 sw0-port2 00:00:00:00:00:02 192.168.33.20/24\n\nls-create sw1\nls-add-port sw1 sw1-port1 00:00:00:00:00:03 192.168.33.30/24\nls-add-port sw1 sw1-port2 00:00:00:00:00:04 192.168.33.40/24\n\novs-add-port br-int lport1 sw0-port1 192.168.33.1\novs-add-port br-int lport2 sw0-port2 192.168.33.1\novs-add-port br-int lport3 sw1-port1 192.168.33.1\novs-add-port br-int lport4 sw1-port2 192.168.33.1\n\nip netns exec lport1-ns ip addr\nip netns exec lport2-ns ip addr\nip netns exec lport3-ns ip addr\nip netns exec lport4-ns ip addr\n\nip netns exec lport1-ns ping -c3 192.168.33.20\nofport=$(ovs-vsctl list interface lport1 | awk '/ofport /{print $3}')\novs-appctl ofproto/trace br-int in_port=$ofport,dl_src=00:00:00:00:00:01,dl_dst=00:00:00:00:00:02 -generate\n\nip netns exec lport1-ns ping -c3 192.168.33.30\novs-appctl ofproto/trace br-int in_port=$ofport,dl_src=00:00:00:00:00:01,dl_dst=00:00:00:00:00:03 -generate\n")])])]),a("p",[s._v("这里ls-create ls-add-port和ovs-add-port是简单封装了一下命令：")]),s._v(" "),a("p",[s._v("ls-create ls-add-port:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ls-create() {\n    ovn-nbctl --may-exist ls-add $switch\n}\n\nls-add-port() {\n    switch=$1\n    port=$2\n    mac=$3\n    cidr=$4\n\n    # 逻辑交换机上创建逻辑端口\n    ovn-nbctl --may-exist lsp-add $switch $port\n\n    # 给逻辑端口设置mac地址\n    ovn-nbctl lsp-set-addresses $port $mac\n\n    # 仅允许该端口源或目的mac为对应地址\n    ovn-nbctl lsp-set-port-security $port $mac $cidr\n}\n")])])]),a("p",[s._v("穿件网络ns，把interface塞到ns中，再与物理端口相关联，然后给interface配置IP")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('ovs-add-port() {\n    bridge=$1\n    port=$2\n    lport=$3\n    gateway=$4\n\n    # 创建一个网络ns\n    ip netns add $port-ns\n    # set interface 很重要，要不然就会只有端口没有interface,所以无法把它塞到ns中\n    ovs-vsctl --may-exist add-port $bridge $port -- set interface $port type=internal\n    if [ ! -z "$lport" ]; then\n        # 把逻辑端口与ovs端口进行关联\n        ovs-vsctl set Interface $port external_ids:iface-id=$lport\n    fi\n\n    pscount=$(ovn-nbctl lsp-get-port-security $lport | wc -l)\n    if [ $pscount = 2 ]; then\n        mac=$(ovn-nbctl lsp-get-port-security $lport | head -n 1)\n        cidr=$(ovn-nbctl lsp-get-port-security $lport | tail -n 1)\n        ip link set $port netns $port-ns\n        # ip netns exec $port-ns ip link set dev $port name eth0\n        ip netns exec $port-ns ip link set $port address $mac\n        ip netns exec $port-ns ip addr add $cidr dev $port\n        ip netns exec $port-ns ip link set $port up\n        if [ ! -z "$gateway" ]; then\n            ip netns exec $port-ns ip route add default via $gateway\n        fi\n    fi\n}\n')])])]),a("p",[s._v("所以在实现专有网络时只需要创建不同的逻辑交换机即可，不通过路由相连专有网络之间就会相互隔离。")]),s._v(" "),a("h2",{attrs:{id:"ip管理（dhcp）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ip管理（dhcp）"}},[s._v("#")]),s._v(" IP管理（DHCP）")]),s._v(" "),a("h2",{attrs:{id:"静态ip配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#静态ip配置"}},[s._v("#")]),s._v(" 静态IP配置")]),s._v(" "),a("p",[s._v("这里给ovn逻辑端口配置一个静态的IP，然后ovn会模拟DHCP协议给端口响应完成地址配置")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('ovn-nbctl lr-add user1\novn-nbctl ls-add vpc1\n\n#创建路由连接到vpc1端口，并分配mac 02:ac:10:ff:34:01 IP 172.66.1.10\novn-nbctl lrp-add user1 user1-vpc1 02:ac:10:ff:34:01 172.66.1.10/24\n\novn-nbctl lsp-add vpc1 vpc1-user1\novn-nbctl lsp-set-type vpc1-user1 router\novn-nbctl lsp-set-addresses vpc1-user1 02:ac:10:ff:34:01\novn-nbctl lsp-set-options vpc1-user1 router-port=user1-vpc1\n\n#创建路由连接到vpc2端口，并分配mac 02:ac:10:ff:34:02 IP 172.77.1.10\novn-nbctl lrp-add user1 user1-vpc2 02:ac:10:ff:34:02 172.77.1.10/24\n\novn-nbctl lsp-add vpc1 vpc1-vm1\n# 这里给逻辑端口配置IP地址\novn-nbctl lsp-set-addresses vpc1-vm1 "02:ac:10:ff:01:30 172.66.1.107" \n# ovn-nbctl lsp-set-port-security vpc1-vm1 "02:ac:10:ff:01:30 172.66.1.101"\n\noptions=$(ovn-nbctl create DHCP_Options cidr=172.66.1.0/24 \\\noptions="\\"server_id\\"=\\"172.66.1.10\\" \\"server_mac\\"=\\"02:ac:10:ff:34:01\\" \\\n\\"lease_time\\"=\\"3600\\" \\"router\\"=\\"172.66.1.10\\"")\n\necho "DHCP options is: " $options\novn-nbctl lsp-set-dhcpv4-options vpc1-vm1 $options\novn-nbctl lsp-get-dhcpv4-options vpc1-vm1\n\nip netns add vm1\novs-vsctl add-port br-int vm1 -- set interface vm1 type=internal\nip link set vm1 address 02:ac:10:ff:01:30\nip link set vm1 netns vm1\novs-vsctl set Interface vm1 external_ids:iface-id=vpc1-vm1\n# 通过DHCP即可拿到地址\nip netns exec vm1 dhclient vm1\nip netns exec vm1 ip addr show vm1\nip netns exec vm1 ip route show\n\nclean() {\n    ip netns del vm1\n    ovn-nbctl ls-del vpc1\n    ovs-vsctl del-port br-int vm1\n}\n')])])]),a("h2",{attrs:{id:"动态获取ip地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#动态获取ip地址"}},[s._v("#")]),s._v(" 动态获取IP地址")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://developers.redhat.com/blog/2018/09/03/ovn-dynamic-ip-address-management/",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考文章"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("ovn支持管理你的IP地址，只需要指定一个子网，就会给借口分配未被占用的IP地址：")]),s._v(" "),a("p",[s._v("大部分操作与静态IP一样，注意下面几个重点注释地方：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('ovn-nbctl lr-add user1\novn-nbctl ls-add vpc1\n# [重点] 需要other_config，否则不会分配地址\novn-nbctl set Logical_Switch vpc1 other_config:subnet=172.66.1.10/24\n\n#创建路由连接到vpc1端口，并分配mac 02:ac:10:ff:34:01 IP 172.66.1.10\novn-nbctl lrp-add user1 user1-vpc1 02:ac:10:ff:34:01 172.66.1.10/24\n\novn-nbctl lsp-add vpc1 vpc1-user1\novn-nbctl lsp-set-type vpc1-user1 router\novn-nbctl lsp-set-addresses vpc1-user1 02:ac:10:ff:34:01\novn-nbctl lsp-set-options vpc1-user1 router-port=user1-vpc1\n\novn-nbctl lsp-add vpc1 vpc1-vm1\n# 【重点】这里不指定具体地址，而使用dynamic\novn-nbctl lsp-set-addresses vpc1-vm1 "02:ac:10:ff:01:30 dynamic"\n# ovn-nbctl lsp-set-addresses vpc1-vm1 "dynamic"\n# ovn-nbctl lsp-set-port-security vpc1-vm1 "02:ac:10:ff:01:30 172.66.1.106"\n\noptions=$(ovn-nbctl create DHCP_Options cidr=172.66.1.0/24 \\\noptions="\\"server_id\\"=\\"172.66.1.10\\" \\"server_mac\\"=\\"02:ac:10:ff:34:01\\" \\\n\\"lease_time\\"=\\"3600\\" \\"router\\"=\\"172.66.1.10\\"")\n\necho "DHCP options is: " $options\novn-nbctl lsp-set-dhcpv4-options vpc1-vm1 $options\novn-nbctl lsp-get-dhcpv4-options vpc1-vm1\n# 这里可以看到分配到的地址\novn-nbctl list logical_switch_port\n\nip netns add vm1\novs-vsctl add-port br-int vm1 -- set interface vm1 type=internal\nip link set vm1 address 02:ac:10:ff:01:30\nip link set vm1 netns vm1\novs-vsctl set Interface vm1 external_ids:iface-id=vpc1-vm1\n# 通过dhclient就可以获取到地址了\nip netns exec vm1 dhclient vm1\nip netns exec vm1 ip addr show vm1\nip netns exec vm1 ip route show\n')])])]),a("p",[s._v("可以查看到已分配的地址：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$ ovn-nbctl list logical_switch_port\n_uuid : 2d1fe408-f119-48d6-88c9-dff237c92856\naddresses : [dynamic]\ndhcpv4_options : []\ndhcpv6_options : []\ndynamic_addresses : "0a:00:00:00:00:01 192.168.0.2 fdd6:8cf5:9dc2:c30a:800:ff:fe00:1"\nenabled : []\nexternal_ids : {}\nname : "port1"\noptions : {}\nparent_name : []\nport_security : []\ntag : []\ntag_request : []\ntype : ""\nup : false\n\n_uuid : 43867394-8d3b-4e36-a90d-5f635d6a084c\naddresses : ["00:ac:00:ff:01:01 dynamic"]\ndhcpv4_options : []\ndhcpv6_options : []\ndynamic_addresses : "00:ac:00:ff:01:01 192.168.0.3 fdd6:8cf5:9dc2:c30a:2ac:ff:feff:101"\nenabled : []\nexternal_ids : {}\nname : "port2"\noptions : {}\nparent_name : []\nport_security : []\ntag : []\ntag_request : []\ntype : ""\nup : false\n')])])]),a("h2",{attrs:{id:"经典网络实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#经典网络实现"}},[s._v("#")]),s._v(" 经典网络实现")]),s._v(" "),a("p",[a("img",{attrs:{src:"/kube-ovn-classics.jpg",alt:""}})]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ovn-nbctl lsp-add out outs-wan\novn-nbctl lsp-set-addresses outs-wan unknown\novn-nbctl lsp-set-type outs-wan localnet # 连接物理网络端口类型\novn-nbctl lsp-set-options outs-wan network_name=wanNet # 做bridge mapping时需要\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ovs-vsctl add-br br-eth\novs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=wanNet:br-eth\novs-vsctl add-port br-eth eth0\n\n#配置网桥IP\nip link set br-eth up\nip addr add 192.168.66.111/23 dev br-eth\n")])])]),a("p",[s._v("把虚拟机关联到逻辑网桥上，这样物理网卡与虚拟机就在一个网桥上了")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ovs-vsctl set Interface vm1 external_ids:iface-id=vm1\n")])])]),a("h2",{attrs:{id:"fip实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fip实现"}},[s._v("#")]),s._v(" FIP实现")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/kube-ovn-vpc.png",alt:""}}),s._v("\n其它部分的链接参考上文，这里主要是路由相关的操作")]),s._v(" "),a("p",[s._v("vm想要出网那么必须要进行源地址转换，就和我们访问google一样，那我们机器的192.168.x.x的地址就会在路由器上被转化")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#对vpc1\novn-nbctl -- --id=@nat create nat type="snat" logical_ip=172.66.1.0/24 \\\nexternal_ip=192.168.66.45 -- add logical_router gateway_route nat @nat\n#会返回uuid\n56ad6c5b-8417-4314-95c4-a0d780b5ef0b\n')])])]),a("p",[s._v("这里66.45是我们链接物理网络的一个地址，告诉路由器使用该地址进行转换")]),s._v(" "),a("p",[s._v("实现FIP其实就是snat dnat都做：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#对vm3 172.66.1.103  绑定外网 192.168.66.46 \novn-nbctl -- --id=@nat create nat type="dnat_and_snat" logical_ip=172.66.1.103 \\\nexternal_ip=192.168.66.46 -- add logical_router gateway_route nat @nat\n')])])]),a("h1",{attrs:{id:"ovn-ovs与cni对接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ovn-ovs与cni对接"}},[s._v("#")]),s._v(" ovn ovs与CNI对接")]),s._v(" "),a("p",[s._v("ovn ovs与CNI对接包含两个部分，CNI插件仅需要把容器的设备对一端挂载到ovs网桥上然后配置好地址,与逻辑端口做好映射. 主要是物理面的功能，逻辑管控层面就可以通过CRD进行创建，所以重点是对ovn ovs CNI本身的掌握。")])])}),[],!1,null,null,null);t.default=e.exports}}]);