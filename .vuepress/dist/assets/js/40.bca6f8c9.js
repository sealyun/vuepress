(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{236:function(e,t,a){"use strict";a.r(t);var n=a(0),r=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"修改kubeadm证书过期时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改kubeadm证书过期时间"}},[e._v("#")]),e._v(" 修改kubeadm证书过期时间")]),e._v(" "),a("p",[e._v("本文通过修改kubeadm源码让kubeadm默认的一年证书过期时间修改为99年")]),e._v(" "),a("p",[e._v("我已经编译好了一个放在了"),a("a",{attrs:{href:"https://github.com/fanux/sealos/releases/tag/kubeadm1.12.2",target:"_blank",rel:"noopener noreferrer"}},[e._v("github"),a("OutboundLink")],1),e._v("上，有需要的可以直接下")]),e._v(" "),a("p",[e._v("使用方法:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("[root@dev-86-202 ~]# chmod +x kubeadm && cp kubeadm /usr/bin\n[root@dev-86-202 ~]# rm /etc/kubernetes/pki/ -rf\n[root@dev-86-202 ~]# kubeadm alpha phase certs all --config  kube/conf/kubeadm.yaml\n")])])]),e._v(" "),a("p",[e._v("更新kubeconfig")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("[root@dev-86-202 ~]# rm -rf /etc/kubernetes/*conf\n[root@dev-86-202 ~]# kubeadm alpha phase kubeconfig all --config ~/kube/conf/kubeadm.yaml\n[root@dev-86-202 ~]# cp /etc/kubernetes/admin.conf ~/.kube/config\n")])])]),a("p",[e._v("验证：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ cd /etc/kubernetes/pki\n$ openssl x509 -in apiserver-etcd-client.crt -text -noout\nCertificate:\n    Data:\n        Version: 3 (0x2)\n        Serial Number: 4701787282062078235 (0x41401a9f34c2711b)\n    Signature Algorithm: sha256WithRSAEncryption\n        Issuer: CN=etcd-ca\n        Validity\n            Not Before: Nov 22 11:58:50 2018 GMT\n            Not After : Oct 29 11:58:51 2117 GMT   # 时间已经变成99年了\n")])])]),a("p",[e._v("其它证书验证同理")]),e._v(" "),a("h2",{attrs:{id:"代码编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#代码编译"}},[e._v("#")]),e._v(" 代码编译")]),e._v(" "),a("p",[e._v("编译环境镜像我已经放到dockerhub上了：fanux/kubernetes-build:v1.0.0")]),e._v(" "),a("p",[e._v("首先clone k8s 代码：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("git clone https://github.com/kubernetes/kubernetes\n")])])]),a("p",[e._v("挂载到镜像中编译")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("docker run --rm -v yourcodedir:/go/src/k8s.io/kubernetes -it fanux/kubernetes-build:v1.0.0 bash\n# cd /go/src/k8s.io/kubernetes\n# make all WHAT=cmd/kubeadm GOFLAGS=-v\n")])])]),a("p",[e._v("编译完产物在 _output/local/bin/linux/amd64/kubeadm 目录下")]),e._v(" "),a("h2",{attrs:{id:"修改代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改代码"}},[e._v("#")]),e._v(" 修改代码")]),e._v(" "),a("p",[e._v("证书时间代码其实在client-go里面，文件是：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("vendor/k8s.io/client-go/util/cert/cert.go\n")])])]),a("p",[e._v("然后看到这个NotAfter的都给改了即可：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("NotAfter:  validFrom.Add(duration365d * longYear)\n")])])]),a("p",[e._v("我这里longYear ＝ 99")]),e._v(" "),a("p",[e._v("然后编译完工")]),e._v(" "),a("p",[e._v("最后在代码里贴上小广告：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('func main() {\n\tif err := app.Run(); err != nil {\n\t\tfmt.Fprintf(os.Stderr, "error: %v\\n", err)\n\t\tos.Exit(1)\n\t}\n\tfmt.Println("*************************************************")\n\tfmt.Println("****         www.sealyun.com                  ***")\n\tfmt.Println("****         kubernetes install in 3 steps    ***")\n\tfmt.Println("****         provide by fanux                 ***")\n\tfmt.Println("*************************************************")\n\tos.Exit(0)\n}\n')])])]),a("p",[e._v("完美")])])}),[],!1,null,null,null);t.default=r.exports}}]);