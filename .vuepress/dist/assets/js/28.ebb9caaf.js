(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{228:function(t,e,s){"use strict";s.r(e);var a=s(0),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"istio安装使用教程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#istio安装使用教程"}},[t._v("#")]),t._v(" istio安装使用教程")]),t._v(" "),s("p",[t._v("祝贺istio1.0发布, 在此献上教程一份")]),t._v(" "),s("h1",{attrs:{id:"安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),s("blockquote",[s("p",[t._v("安装k8s "),s("a",{attrs:{href:"http://sealyun.com/pro/products/",target:"_blank",rel:"noopener noreferrer"}},[t._v("强势插播广告"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("三步安装，不多说")]),t._v(" "),s("blockquote",[s("p",[t._v("安装helm, 推荐生产环境用helm安装，可以调参\n")])]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/helm/helm/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("release地址"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("如我使用的2.9.1版本")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("yum install -y socat # 这个不装会报错\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("[root@istiohost ~]# wget https://storage.googleapis.com/kubernetes-helm/helm-v2.9.1-linux-amd64.tar.gz\n[root@istiohost ~]# tar zxvf helm-v2.9.1-linux-amd64.tar.gz\n[root@istiohost ~]# cp linux-amd64/helm /usr/bin\n")])])]),s("p",[t._v("先创建一个service account 把管理员权限给helm:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('[root@istiohost ~]# cat helmserviceaccount.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: tiller\n  namespace: kube-system\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: tiller-clusterrolebinding\nsubjects:\n- kind: ServiceAccount\n  name: tiller\n  namespace: kube-system\nroleRef:\n  kind: ClusterRole\n  name: cluster-admin\n  apiGroup: ""\n')])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl create -f  helmserviceaccount.yaml\n")])])]),s("p",[t._v("安装helm 服务端 tiller :")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("helm init  --service-account tiller #  如果已安装更新加 --upgrade 参数\nhelm list #没任何返回表示成功\n")])])]),s("blockquote",[s("p",[t._v("安装istio")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("curl -L https://git.io/getLatestIstio | sh -\ncd istio-1.0.0/\nexport PATH=$PWD/bin:$PATH\n")])])]),s("p",[t._v("helm 2.10.0以前的版本需要装一下CRD：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml\nkubectl apply -f install/kubernetes/helm/istio/charts/certmanager/templates/crds.yaml\n")])])]),s("p",[t._v("安装istio, 由于你没有LB所以用NodePort代替:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("helm install install/kubernetes/helm/istio  --name istio --namespace istio-system --set gateways.istio-ingressgateway.type=NodePort --set gateways.istio-egressgateway.type=NodePort\n")])])]),s("p",[t._v("安装成功：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("[root@istiohost istio-1.0.0]# kubectl get pod -n istio-system\nNAME                                        READY     STATUS    RESTARTS   AGE\nistio-citadel-7d8f9748c5-ntqnp              1/1       Running   0          5m\nistio-egressgateway-676c8546c5-2w4cq        1/1       Running   0          5m\nistio-galley-5669f7c9b-mkxjg                1/1       Running   0          5m\nistio-ingressgateway-5475685bbb-96mbr       1/1       Running   0          5m\nistio-pilot-5795d6d695-gr4h4                2/2       Running   0          5m\nistio-policy-7f945bf487-gkpxr               2/2       Running   0          5m\nistio-sidecar-injector-d96cd9459-674pk      1/1       Running   0          5m\nistio-statsd-prom-bridge-549d687fd9-6cbzs   1/1       Running   0          5m\nistio-telemetry-6c587bdbc4-jndjn            2/2       Running   0          5m\nprometheus-6ffc56584f-98mr9                 1/1       Running   0          5m\n[root@istiohost istio-1.0.0]# kubectl get svc -n istio-system\nNAME                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                     AGE\nistio-citadel              ClusterIP   10.108.253.89    <none>        8060/TCP,9093/TCP                                                                                           5m\nistio-egressgateway        NodePort    10.96.151.14     <none>        80:30830/TCP,443:30038/TCP                                                                                  5m\nistio-galley               ClusterIP   10.102.83.130    <none>        443/TCP,9093/TCP                                                                                            5m\nistio-ingressgateway       NodePort    10.99.194.13     <none>        80:31380/TCP,443:31390/TCP,31400:31400/TCP,15011:31577/TCP,8060:30037/TCP,15030:31855/TCP,15031:30775/TCP   5m\nistio-pilot                ClusterIP   10.101.4.143     <none>        15010/TCP,15011/TCP,8080/TCP,9093/TCP                                                                       5m\nistio-policy               ClusterIP   10.106.221.68    <none>        9091/TCP,15004/TCP,9093/TCP                                                                                 5m\nistio-sidecar-injector     ClusterIP   10.100.5.170     <none>        443/TCP                                                                                                     5m\nistio-statsd-prom-bridge   ClusterIP   10.107.28.242    <none>        9102/TCP,9125/UDP                                                                                           5m\nistio-telemetry            ClusterIP   10.105.66.20     <none>        9091/TCP,15004/TCP,9093/TCP,42422/TCP                                                                       5m\nprometheus                 ClusterIP   10.103.128.152   <none>        9090/TCP\n")])])]),s("h1",{attrs:{id:"使用教程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用教程"}},[t._v("#")]),t._v(" 使用教程")]),t._v(" "),s("h2",{attrs:{id:"官网事例-bookinfo-application"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#官网事例-bookinfo-application"}},[t._v("#")]),t._v(" 官网事例 Bookinfo Application")]),t._v(" "),s("p",[s("img",{attrs:{src:"/noistio.svg",alt:""}})]),t._v(" "),s("ul",[s("li",[t._v("productpage 调用details和reviews渲染页面")]),t._v(" "),s("li",[t._v("details包含书本信息")]),t._v(" "),s("li",[t._v("reviews 书本反馈，调用ratings服务")]),t._v(" "),s("li",[t._v("ratings 书本租借信息")])]),t._v(" "),s("p",[t._v("reviews服务有三个版本:")]),t._v(" "),s("ul",[s("li",[t._v("V1 不请求ratings")]),t._v(" "),s("li",[t._v("V2 请求ratings，返回1到5个黑星")]),t._v(" "),s("li",[t._v("V3 请求ratings，返回1到5个红星")])]),t._v(" "),s("p",[t._v("数据平面：\n"),s("img",{attrs:{src:"/withistio.svg",alt:""}})]),t._v(" "),s("p",[t._v("安装应用：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f <(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)\n")])])]),s("p",[t._v("安装完成：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("[root@istiohost istio-1.0.0]# kubectl get services\nNAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\ndetails       ClusterIP   10.104.66.31    <none>        9080/TCP   2m\nkubernetes    ClusterIP   10.96.0.1       <none>        443/TCP    4h\nproductpage   ClusterIP   10.109.68.13    <none>        9080/TCP   2m\nratings       ClusterIP   10.99.55.110    <none>        9080/TCP   2m\nreviews       ClusterIP   10.102.19.129   <none>        9080/TCP   2m\n[root@istiohost istio-1.0.0]# kubectl get pods\nNAME                              READY     STATUS    RESTARTS   AGE\ndetails-v1-fc9649d9c-dpnlp        2/2       Running   0          2m\nproductpage-v1-58845c779c-7g8th   2/2       Running   0          2m\nratings-v1-6cc485c997-fb7nh       2/2       Running   0          2m\nreviews-v1-76987687b7-x5n7z       2/2       Running   0          2m\nreviews-v2-86749dcd5-xchzb        2/2       Running   0          2m\nreviews-v3-7f4746b959-nthrq       2/2       Running   0          2m\n")])])]),s("p",[t._v("创建一个gateway,这是为了集群外可以访问")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml\n")])])]),s("p",[t._v("浏览器访问url:\n47.254.28.88是我的节点ip，使用nodeport模式")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("http://47.254.28.88:31380/productpage \n")])])]),s("p",[t._v("连续点击三次，你会发现右边没星星-> 黑星星-> 红星星切换，对应三个版本的review,默认策略是轮询")]),t._v(" "),s("p",[t._v("创建destination rules, 配置路由访问规则，现在还是轮询")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml\n")])])]),s("h1",{attrs:{id:"智能路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#智能路由"}},[t._v("#")]),t._v(" 智能路由")]),t._v(" "),s("h2",{attrs:{id:"请求路由-request-routing"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#请求路由-request-routing"}},[t._v("#")]),t._v(" 请求路由 request routing")]),t._v(" "),s("h3",{attrs:{id:"根据版本路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#根据版本路由"}},[t._v("#")]),t._v(" 根据版本路由")]),t._v(" "),s("p",[t._v("把所有路由切换到v1版本")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml\n")])])]),s("p",[t._v("这样执行完后，不管怎么刷页面，我们都看不到星星，因为v1版本没星")]),t._v(" "),s("p",[t._v("可以看到destination是这样的：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("  http:\n  - route:\n    - destination:\n        host: details\n        subset: v1\n")])])]),s("p",[t._v("试想如此我们做版本切换将是何等简单")]),t._v(" "),s("h3",{attrs:{id:"根据用户路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#根据用户路由"}},[t._v("#")]),t._v(" 根据用户路由")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml\n")])])]),s("p",[t._v("你会发现用jason用户登录就能看到黑星星，而其它方式看到的页面都是无星星")]),t._v(" "),s("p",[t._v("因为这个user走了v2版本，能不强大？  那当然还能根据header什么的做路由了，就不多说了")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n")])])]),s("h2",{attrs:{id:"故障注入-fault-injection"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#故障注入-fault-injection"}},[t._v("#")]),t._v(" 故障注入 Fault injection")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml\nkubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml\n")])])]),s("p",[t._v("假设代码里有个bug，用户jason, reviews:v2 访问ratings时会卡10s, 我们任然希望端到端的测试能正常走完")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml\n")])])]),s("p",[t._v("注入错误让jason用户有个7s的延迟")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("  hosts:\n  - ratings\n  http:\n  - fault:\n      delay:\n        fixedDelay: 7s\n        percent: 100\n    match:\n    - headers:\n        end-user:\n          exact: jason\n    route:\n    - destination:\n        host: ratings\n        subset: v1\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n")])])]),s("p",[t._v("这时访问页面显然会出错，因为我们希望7s内能返回,这样我们就发现了一个延迟的bug")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Error fetching product reviews!\nSorry, product reviews are currently unavailable for this book.\n")])])]),s("p",[t._v("所以我们就可能通过故障注入去发现这些异常现象")]),t._v(" "),s("h2",{attrs:{id:"链路切换-traffic-shifting"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#链路切换-traffic-shifting"}},[t._v("#")]),t._v(" 链路切换 Traffic Shifting")]),t._v(" "),s("p",[t._v("我们先把50%流量发送给reviews:v1 50%流量发送给v3，然后再把100%的流量都切给v3")]),t._v(" "),s("h3",{attrs:{id:"把100-流量切到v1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#把100-流量切到v1"}},[t._v("#")]),t._v(" 把100%流量切到v1")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml\n")])])]),s("p",[t._v("此时不论刷几遍，都没有星星")]),t._v(" "),s("h3",{attrs:{id:"v1-v3各50-流量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#v1-v3各50-流量"}},[t._v("#")]),t._v(" v1 v3各50%流量")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("  - route:\n    - destination:\n        host: reviews\n        subset: v1\n      weight: 50\n    - destination:\n        host: reviews\n        subset: v3\n      weight: 50\n")])])]),s("p",[t._v("此时一会有星，一会没星，但是已经不是轮询算法了")]),t._v(" "),s("h3",{attrs:{id:"全切v3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全切v3"}},[t._v("#")]),t._v(" 全切v3")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml\n")])])]),s("p",[t._v("这时不管怎么刷都是红心了")])])}),[],!1,null,null,null);e.default=n.exports}}]);